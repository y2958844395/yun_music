// pages/Mine.ets
import { UserService } from '../utils/UserService';
import { ApiResponse, User, UploadResult } from '../models/User';
import { promptAction } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { BASE_URL, HttpUtil } from '../utils/HttpUtil';
import { common } from '@kit.AbilityKit';
import { rcp } from '@kit.RemoteCommunicationKit';
import fs from '@ohos.file.fs';

interface GeneratedTypeLiteralInterface_1 {
  success: boolean;
  message: string;
}

interface GeneratedTypeLiteralInterface_2 {
  copyPath: string;
  sandboxPath: string;
  fileName: string;
}
interface MineProps {
  onNavigateToLogin?: () => void;
}
@Component
export struct Mine {
  onNavigateToLogin?: () => void;
  @State currentUser: User | null = null;
  @State isLoading: boolean = false;
  @State showEditProfile: boolean = false;
  @State showChangePassword: boolean = false;
  @State isUploadingAvatar: boolean = false;

  // ç¼–è¾‘èµ„æ–™ç›¸å…³çŠ¶æ€
  @State editNickname: string = '';
  @State editBio: string = '';
  @State isUpdatingProfile: boolean = false;
  @State profileErrorMessage: string = '';

  // ä¿®æ”¹å¯†ç ç›¸å…³çŠ¶æ€
  @State oldPassword: string = '';
  @State newPassword: string = '';
  @State confirmNewPassword: string = '';
  @State isChangingPassword: boolean = false;
  @State passwordErrorMessage: string = '';

  async aboutToAppear() {
    await this.loadUserInfo();
  }

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  private async loadUserInfo() {
    this.isLoading = true;
    try {
      const result = await UserService.getProfile();
      if (result.success && result.user) {
        this.currentUser = result.user;
        this.editNickname = result.user.nickname || '';
        this.editBio = result.user.bio || '';
      } else {
        // å¦‚æœè·å–å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨è·å–
        this.currentUser = await UserService.getCurrentUser();
        if (this.currentUser) {
          this.editNickname = this.currentUser.nickname || '';
          this.editBio = this.currentUser.bio || '';
        }
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // é€‰æ‹©å¹¶ä¸Šä¼ å¤´åƒ
  private async handleAvatarUpload(): Promise<void> {
    try {
      this.isUploadingAvatar = true;

      // è·å–context
      const context = getContext(this) as common.UIAbilityContext;

      // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨å®ä¾‹
      const documentViewPicker = new picker.DocumentViewPicker(context);
      const documentSelectOptions = new picker.DocumentSelectOptions();
      documentSelectOptions.maxSelectNumber = 1;
      documentSelectOptions.fileSuffixFilters = ['.png', '.jpg', '.jpeg'];
      documentSelectOptions.authMode = true;

      const result = await documentViewPicker.select(documentSelectOptions);

      if (result && result.length > 0) {
        const fileUri = result[0];

        // è°ƒç”¨ä¸Šä¼ å¤´åƒæ¥å£
        const uploadResult = await this.uploadAvatar(fileUri, context);
        if (uploadResult.success) {
          promptAction.showToast({
            message: 'å¤´åƒä¸Šä¼ æˆåŠŸ',
            duration: 2000
          });
          await this.loadUserInfo();
        } else {
          promptAction.showToast({
            message: uploadResult.message || 'å¤´åƒä¸Šä¼ å¤±è´¥',
            duration: 2000
          });
        }
      }
    } catch (error) {
      console.error('é€‰æ‹©å¤´åƒå¤±è´¥:', error);
      promptAction.showToast({
        message: 'é€‰æ‹©å¤´åƒå¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isUploadingAvatar = false;
    }
  }

  // ä¸Šä¼ å¤´åƒåˆ°æœåŠ¡å™¨
  private async uploadAvatar(fileUri: string, context: common.UIAbilityContext): Promise<UploadResult> {
    try {
      const token = await UserService.getToken();
      if (!token) {
        return { success: false, message: 'æœªç™»å½•' };
      }

      // æ–‡ä»¶å¤„ç†ï¼šæ‹·è´åˆ°æ²™ç®±ç›®å½•
      const fileInfo = await this.prepareFileForUpload(fileUri, context);

      try {
        const response = await HttpUtil.uploadFileWithHttpRequest(
          '/upload-avatar',
          fileInfo.sandboxPath,
          fileInfo.fileName,
          'avatar',
          token
        );

        if (response.code === 200) {
          return { success: true, message: 'ä¸Šä¼ æˆåŠŸ' };
        } else {
          return { success: false, message: response.message || 'ä¸Šä¼ å¤±è´¥' };
        }
      } finally {
        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        try {
          fs.unlinkSync(fileInfo.copyPath);
        } catch (cleanupError) {
          console.warn('æ¸…ç†ç¼“å­˜æ–‡ä»¶å¤±è´¥:', cleanupError);
        }
      }
    } catch (error) {
      console.error('ä¸Šä¼ å¤´åƒå¤±è´¥:', error);
      return { success: false, message: 'ç½‘ç»œé”™è¯¯' };
    }
  }

  // å‡†å¤‡æ–‡ä»¶ç”¨äºä¸Šä¼ 
  private async prepareFileForUpload(fileUri: string, context: common.UIAbilityContext): Promise<GeneratedTypeLiteralInterface_2> {
    // è·å–æ–‡ä»¶æ‰©å±•å
    const fileExtension = fileUri.split('.').pop() || 'jpg';
    const fileName = Date.now() + '.' + fileExtension;

    // æ‹·è´åˆ°ç¼“å­˜ç›®å½•çš„å®Œæ•´è·¯å¾„
    const copyPath = context.cacheDir + '/' + fileName;

    // æ„é€ æ²™ç®±è·¯å¾„ï¼ˆç”¨äºä¸Šä¼ ï¼‰
    const sandboxPath = 'internal://cache/' + fileName;

    // æ‰“å¼€åŸæ–‡ä»¶å¹¶æ‹·è´
    const file = fs.openSync(fileUri, fs.OpenMode.READ_ONLY);
    try {
      fs.copyFileSync(file.fd, copyPath);
    } finally {
      fs.closeSync(file);
    }

    return {
      copyPath,
      sandboxPath,
      fileName
    };
  }
  // éªŒè¯èµ„æ–™ç¼–è¾‘è¾“å…¥
  private validateProfileInput(): boolean {
    if (!this.editNickname.trim()) {
      this.profileErrorMessage = 'è¯·è¾“å…¥æ˜µç§°';
      return false;
    }
    if (this.editNickname.length > 50) {
      this.profileErrorMessage = 'æ˜µç§°é•¿åº¦ä¸èƒ½è¶…è¿‡50å­—ç¬¦';
      return false;
    }
    if (this.editBio.length > 200) {
      this.profileErrorMessage = 'ä¸ªäººç®€ä»‹é•¿åº¦ä¸èƒ½è¶…è¿‡200å­—ç¬¦';
      return false;
    }
    return true;
  }

  // æ›´æ–°ç”¨æˆ·èµ„æ–™
  private async handleUpdateProfile() {
    if (!this.validateProfileInput()) {
      return;
    }

    this.isUpdatingProfile = true;
    this.profileErrorMessage = '';

    try {
      const result = await UserService.updateProfile({
        nickname: this.editNickname,
        bio: this.editBio
      });

      if (result.success) {
        this.currentUser = result.user || this.currentUser;
        this.showEditProfile = false;
        promptAction.showToast({
          message: 'èµ„æ–™æ›´æ–°æˆåŠŸ',
          duration: 2000
        });
      } else {
        this.profileErrorMessage = result.message;
      }
    } catch (error) {
      console.error('æ›´æ–°èµ„æ–™å¤±è´¥:', error);
      this.profileErrorMessage = 'æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•';
    } finally {
      this.isUpdatingProfile = false;
    }
  }

  // éªŒè¯å¯†ç ä¿®æ”¹è¾“å…¥
  private validatePasswordInput(): boolean {
    if (!this.oldPassword.trim()) {
      this.passwordErrorMessage = 'è¯·è¾“å…¥å½“å‰å¯†ç ';
      return false;
    }
    if (!this.newPassword.trim()) {
      this.passwordErrorMessage = 'è¯·è¾“å…¥æ–°å¯†ç ';
      return false;
    }
    if (this.newPassword.length < 6) {
      this.passwordErrorMessage = 'æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½';
      return false;
    }
    if (this.newPassword !== this.confirmNewPassword) {
      this.passwordErrorMessage = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
      return false;
    }
    if (this.oldPassword === this.newPassword) {
      this.passwordErrorMessage = 'æ–°å¯†ç ä¸èƒ½ä¸å½“å‰å¯†ç ç›¸åŒ';
      return false;
    }
    return true;
  }

  // ä¿®æ”¹å¯†ç 
  private async handleChangePassword() {
    if (!this.validatePasswordInput()) {
      return;
    }

    this.isChangingPassword = true;
    this.passwordErrorMessage = '';

    try {
      const result = await UserService.changePassword({
        old_password: this.oldPassword,
        new_password: this.newPassword,
        confirm_password: this.confirmNewPassword
      });

      if (result.success) {
        this.showChangePassword = false;
        this.oldPassword = '';
        this.newPassword = '';
        this.confirmNewPassword = '';
        promptAction.showToast({
          message: 'å¯†ç ä¿®æ”¹æˆåŠŸ',
          duration: 2000
        });
      } else {
        this.passwordErrorMessage = result.message;
      }
    } catch (error) {
      console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
      this.passwordErrorMessage = 'ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•';
    } finally {
      this.isChangingPassword = false;
    }
  }

  // ç™»å‡º
  private async handleLogout() {
    try {
      await UserService.logout();

      this.currentUser = null;
      this.editNickname = '';
      this.editBio = '';
      this.oldPassword = '';
      this.newPassword = '';
      this.confirmNewPassword = '';
      this.profileErrorMessage = '';
      this.passwordErrorMessage = '';
      this.showEditProfile = false;
      this.showChangePassword = false;
      this.isUploadingAvatar = false;
      this.isUpdatingProfile = false;
      this.isChangingPassword = false;
      this.isLoading = false;

      promptAction.showToast({
        message: 'å·²é€€å‡ºç™»å½•',
        duration: 2000
      });
    } catch (error) {
      console.error('ç™»å‡ºå¤±è´¥:', error);
    }
  }

  // æ„å»ºå¤´åƒæ˜¾ç¤º
  @Builder
  private buildAvatar() {
    Stack() {
      if (this.currentUser?.avatar) {
        Image(`${BASE_URL}/avatar/${this.currentUser.avatar}`)
          .width(100)
          .height(100)
          .borderRadius(50)
          .alt($r('app.media.avatar'))
      } else {
        Image($r('app.media.avatar'))
          .width(100)
          .height(100)
          .borderRadius(50)
      }

      // ä¸Šä¼ ä¸­çš„åŠ è½½æŒ‡ç¤ºå™¨
      if (this.isUploadingAvatar) {
        LoadingProgress()
          .width(100)
          .height(100)
          .backgroundColor('rgba(0,0,0,0.7)')
          .borderRadius(50)
      }

      // ç‚¹å‡»æç¤ºæ–‡å­—
      Text('ç‚¹å‡»æ›´æ¢')
        .fontSize(10)
        .fontColor('#FFFFFF')
        .backgroundColor('rgba(0,0,0,0.8)')
        .borderRadius(10)
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .position({ x: 25, y: 75 })
    }
    .onClick(() => {
      if (!this.isUploadingAvatar) {
        this.handleAvatarUpload();
      }
    })
  }

  // æ„å»ºç¼–è¾‘èµ„æ–™å¯¹è¯æ¡†
  @Builder
  private buildEditProfileDialog() {
    if (this.showEditProfile) {
      Column() {
        Text('ç¼–è¾‘èµ„æ–™')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .margin({ bottom: 24 })

        Column({ space: 16 }) {
          // æ˜µç§°è¾“å…¥
          TextInput({ placeholder: 'è¯·è¾“å…¥æ˜µç§°', text: this.editNickname })
            .backgroundColor('#2D2B29')
            .fontColor('#FFFFFF')
            .placeholderColor('#817D83')
            .borderRadius(8)
            .onChange((value) => {
              this.editNickname = value;
              this.profileErrorMessage = '';
            })

          // ä¸ªäººç®€ä»‹è¾“å…¥
          TextArea({ placeholder: 'è¯·è¾“å…¥ä¸ªäººç®€ä»‹ï¼ˆå¯é€‰ï¼‰', text: this.editBio })
            .height(80)
            .backgroundColor('#2D2B29')
            .fontColor('#FFFFFF')
            .placeholderColor('#817D83')
            .borderRadius(8)
            .onChange((value) => {
              this.editBio = value;
              this.profileErrorMessage = '';
            })

          // é”™è¯¯ä¿¡æ¯
          if (this.profileErrorMessage) {
            Text(this.profileErrorMessage)
              .fontSize(14)
              .fontColor('#FF6B6B')
          }

          // æŒ‰é’®ç»„
          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .layoutWeight(1)
              .backgroundColor('#3D3B37')
              .fontColor('#FFFFFF')
              .borderRadius(8)
              .onClick(() => {
                this.showEditProfile = false;
                this.profileErrorMessage = '';
              })

            Button(this.isUpdatingProfile ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜')
              .layoutWeight(1)
              .enabled(!this.isUpdatingProfile)
              .backgroundColor('#4ECDC4')
              .fontColor('#FFFFFF')
              .borderRadius(8)
              .onClick(() => {
                this.handleUpdateProfile();
              })
          }
        }
      }
      .padding(24)
      .backgroundColor('#1C1C1E')
      .borderRadius(16)
      .margin(20)
    }
  }

  // æ„å»ºä¿®æ”¹å¯†ç å¯¹è¯æ¡†
  @Builder
  private buildChangePasswordDialog() {
    if (this.showChangePassword) {
      Column() {
        Text('ä¿®æ”¹å¯†ç ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .margin({ bottom: 24 })

        Column({ space: 16 }) {
          // å½“å‰å¯†ç 
          TextInput({ placeholder: 'è¯·è¾“å…¥å½“å‰å¯†ç ' })
            .type(InputType.Password)
            .backgroundColor('#2D2B29')
            .fontColor('#FFFFFF')
            .placeholderColor('#817D83')
            .borderRadius(8)
            .onChange((value) => {
              this.oldPassword = value;
              this.passwordErrorMessage = '';
            })

          // æ–°å¯†ç 
          TextInput({ placeholder: 'è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰' })
            .type(InputType.Password)
            .backgroundColor('#2D2B29')
            .fontColor('#FFFFFF')
            .placeholderColor('#817D83')
            .borderRadius(8)
            .onChange((value) => {
              this.newPassword = value;
              this.passwordErrorMessage = '';
            })

          // ç¡®è®¤æ–°å¯†ç 
          TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ' })
            .type(InputType.Password)
            .backgroundColor('#2D2B29')
            .fontColor('#FFFFFF')
            .placeholderColor('#817D83')
            .borderRadius(8)
            .onChange((value) => {
              this.confirmNewPassword = value;
              this.passwordErrorMessage = '';
            })

          // é”™è¯¯ä¿¡æ¯
          if (this.passwordErrorMessage) {
            Text(this.passwordErrorMessage)
              .fontSize(14)
              .fontColor('#FF6B6B')
          }

          // æŒ‰é’®ç»„
          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .layoutWeight(1)
              .backgroundColor('#3D3B37')
              .fontColor('#FFFFFF')
              .borderRadius(8)
              .onClick(() => {
                this.showChangePassword = false;
                this.passwordErrorMessage = '';
                this.oldPassword = '';
                this.newPassword = '';
                this.confirmNewPassword = '';
              })

            Button(this.isChangingPassword ? 'ä¿®æ”¹ä¸­...' : 'ç¡®è®¤ä¿®æ”¹')
              .layoutWeight(1)
              .enabled(!this.isChangingPassword)
              .backgroundColor('#FF6B6B')
              .fontColor('#FFFFFF')
              .borderRadius(8)
              .onClick(() => {
                this.handleChangePassword();
              })
          }
        }
      }
      .padding(24)
      .backgroundColor('#1C1C1E')
      .borderRadius(16)
      .margin(20)
    }
  }

  private handleGoToLogin() {
    if (this.onNavigateToLogin) {
      this.onNavigateToLogin();
    } else {
      promptAction.showToast({
        message: 'è¯·å…ˆç™»å½•',
        duration: 2000
      });
    }
  }

  // ä¿®æ”¹ build æ–¹æ³•ä¸­çš„ç™»å‡ºæŒ‰é’®éƒ¨åˆ†
  build() {
    Stack() {
      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column() {
          LoadingProgress()
            .width(60)
            .height(60)
            .color('#FFFFFF')
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor('#817D83')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (!this.currentUser) {
        // æœªç™»å½•çŠ¶æ€ - æ˜¾ç¤ºç™»å½•æç¤º
        Column() {
          Image($r('app.media.avatar'))
            .width(100)
            .height(100)
            .borderRadius(50)
            .margin({ bottom: 20 })

          Text('æœªç™»å½•')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .margin({ bottom: 8 })

          Text('ç™»å½•åæŸ¥çœ‹æ›´å¤šåŠŸèƒ½')
            .fontSize(16)
            .fontColor('#817D83')
            .margin({ bottom: 40 })

          Button('ç‚¹å‡»ç™»å½•')
            .width('calc(100% - 32vp)')
            .height(52)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor('#4ECDC4')
            .borderRadius(26)
            .onClick(() => {
              this.handleGoToLogin();
            })

          Blank()
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .padding(16)
      } else {
        // å·²ç™»å½•çŠ¶æ€ - æ˜¾ç¤ºå®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ç•Œé¢
        Column() {
          // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          Column() {
            // å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯
            Column({ space: 16 }) {
              this.buildAvatar()

              Text(this.currentUser?.nickname || this.currentUser?.username || 'æœªçŸ¥ç”¨æˆ·')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')

              Text(`@${this.currentUser?.username || ''}`)
                .fontSize(16)
                .fontColor('#817D83')

              if (this.currentUser?.bio) {
                Text(this.currentUser.bio)
                  .fontSize(15)
                  .fontColor('#B3B3B3')
                  .textAlign(TextAlign.Center)
                  .maxLines(3)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .margin({ top: 8 })
                  .padding({ left: 16, right: 16 })
              }
            }
            .padding({ top: 32, bottom: 24, left: 24, right: 24 })
          }
          .width('100%')
          .backgroundColor('#2D2B29')
          .borderRadius(16)
          .margin({ top: 20, left: 16, right: 16 })

          // åŠŸèƒ½èœå•
          Column({ space: 16 }) {
            // ç¼–è¾‘èµ„æ–™
            Row() {
              Text('ğŸµ ç¼–è¾‘èµ„æ–™')
                .fontSize(16)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
            .height(52)
            .padding({ left: 20, right: 20 })
            .backgroundImageSize(ImageSize.Cover)
            .borderRadius(12)
            .justifyContent(FlexAlign.Start)
            .onClick(() => {
              this.showEditProfile = true;
            })

            // ä¿®æ”¹å¯†ç 
            Row() {
              Text('ğŸ” ä¿®æ”¹å¯†ç ')
                .fontSize(16)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Medium)
            }
            .width('100%')
            .height(52)
            .padding({ left: 20, right: 20 })
            .backgroundColor('#660000')
            .borderRadius(12)
            .justifyContent(FlexAlign.Start)
            .onClick(() => {
              this.showChangePassword = true;
            })

            // è´¦æˆ·ä¿¡æ¯
            Column({ space: 12 }) {
              Text('ğŸ“± è´¦æˆ·ä¿¡æ¯')
                .fontSize(16)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Bold)
                .alignSelf(ItemAlign.Start)

              Column({ space: 8 }) {
                Text(`é‚®ç®±: ${this.currentUser?.email || ''}`)
                  .fontSize(14)
                  .fontColor('#B3B3B3')
                  .alignSelf(ItemAlign.Start)

                Text(`æ³¨å†Œæ—¶é—´: ${this.currentUser?.created_at ? new Date(this.currentUser.created_at).toLocaleDateString() : ''}`)
                  .fontSize(14)
                  .fontColor('#B3B3B3')
                  .alignSelf(ItemAlign.Start)
              }
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#382e2f')
            .borderRadius(12)
            .alignItems(HorizontalAlign.Start)
          }
          .padding(16)

          // ç™»å‡ºæŒ‰é’®
          Button('é€€å‡ºç™»å½•')
            .width('calc(100% - 32vp)')
            .height(52)
            .fontSize(16)
            .fontColor('#FF6B6B')
            .backgroundColor('rgba(255, 107, 107, 0.1)')
            .border({ width: 1, color: '#FF6B6B' })
            .borderRadius(26)
            .margin({ top: 16, left: 16, right: 16 })
            .onClick(() => {
              this.handleLogout();
            })

          Blank()
        }
        .width('100%')
        .height('100%')
      }

      // å¯¹è¯æ¡†è¦†ç›–å±‚
      if (this.showEditProfile || this.showChangePassword) {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.8)')
          .onClick(() => {
            this.showEditProfile = false;
            this.showChangePassword = false;
          })
      }

      // ç¼–è¾‘èµ„æ–™å¯¹è¯æ¡†
      this.buildEditProfileDialog()

      // ä¿®æ”¹å¯†ç å¯¹è¯æ¡†
      this.buildChangePasswordDialog()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000') // æ·±è‰²èƒŒæ™¯ä¸Recommendä¿æŒä¸€è‡´
  }
}

// ä¿æŒRecommendç»„ä»¶ä¸å˜
interface recommendDailyType {
  img: string // å›¾ç‰‡
  title: string // ç®€ä»‹æ–‡å­—
  type: string // æ ‡é¢˜æ–‡å­—
  top: string // æ ‡é¢˜èƒŒæ™¯è‰²
  bottom: string // ç®€ä»‹èƒŒæ™¯è‰²
}

interface recommendListType {
  img: string
  title: string
  count: string
}

@Component
export struct Recommend {
  // ... ä¿æŒåŸæœ‰ä»£ç ä¸å˜
  // è½®æ’­å›¾æ•°æ®
  swiperList: string[] = [
    "http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/banner1.png",
    "http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/banner2.png",
    "http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/banner3.png",
    "http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/banner4.png",
    "http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/banner5.png"
  ]
  // æ¯æ—¥æ¨èæ•°æ®
  dailyRecommend: recommendDailyType[] = [
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/recommend1.png',
      title: 'æ¯æ—¥æ¨è | ä»Šå¤©ä»ã€Šä¸å¾—ä¸çˆ±ã€‹å¬èµ· | ç§äººé›·è¾¾',
      type: 'æ¯æ—¥æ¨è',
      top: '#660000',
      bottom: '#382e2f'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/recommend2.png',
      title: 'ä» [Nothing on Me] å¼€å¯æ— é™æ¼«æ¸¸',
      type: 'ç§äººæ¼«æ¸¸',
      top: '#382e2f',
      bottom: '#a37862'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/recommend3.png',
      title: 'æ¯æ—¥æ¨è | ä»Šå¤©ä»ã€Šä¸å¾—ä¸çˆ±ã€‹å¬èµ· | ç§äººé›·è¾¾',
      type: 'åè¯­æµè¡Œ',
      top: '#a37862',
      bottom: '#174847'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/recommend4.png',
      title: 'æ¯æ—¥æ¨è | ä»Šå¤©ä»ã€Šä¸å¾—ä¸çˆ±ã€‹å¬èµ· | ç§äººé›·è¾¾',
      type: 'ç§äººé›·è¾¾',
      top: '#174847',
      bottom: '#174847'
    }
  ]
  // æ¨èæ­Œå•æ•°æ®
  recommendList: recommendListType[] = [
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/list1.jpg',
      title: 'æ¯æ—¥æ¨è | ä»Šå¤©ä»ã€Šä¸å¾—ä¸çˆ±ã€‹å¬èµ· | ç§äººé›·è¾¾',
      count: '270.9ä¸‡'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/list2.jpg',
      title: 'Yasuoå’Œæ›´å¤šå¥½å¬çš„ | åè¯­ç§äººé›·è¾¾ | å›å¿†8090',
      count: '476.1ä¸‡'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/list3.jpg',
      title: 'Trap Remixä¸¨å½“æ¬§ç¾çƒ­å•é‡ä¸Šæ¯’æ€§ä½éŸ³',
      count: '186.3ä¸‡'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/list4.jpg',
      title: 'æ»¡çº§äººç±»è¿›åŒ–ä¹‹è·¯å¿…å¤‡BGM | æ ¹æœ¬åœä¸ä¸‹æ¥',
      count: '186.3ä¸‡'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/list5.jpg',
      title: 'è®¤çœŸå»è†å¬è¿™ä¸ªä¸–ç•Œçš„æ¯ä¸€åˆ†æ¯ä¸€ç§’ (å¼ºçƒˆæ¨è)',
      count: '362.8ä¸‡'
    },
    {
      img: 'http://yjy-teach-oss.oss-cn-beijing.aliyuncs.com/HeimaCloudMusic/list5.jpg',
      title: 'è®¤çœŸå»è†å¬è¿™ä¸ªä¸–ç•Œçš„æ¯ä¸€åˆ†æ¯ä¸€ç§’ (å¼ºçƒˆæ¨è)',
      count: '362.8ä¸‡'
    }
  ]
  @State refreshing: boolean = false

  @Builder
  titleBuilder(title: string) {
    Row() {
      Text(title)
        .fontColor('#fff')
        .fontWeight(700)
        .layoutWeight(1)
      Image($r('app.media.ic_more'))
        .width(22)
        .fillColor('#fff')
    }
    .width('100%')
    .height(40)
  }

  build() {
    Column({ space: 10 }) {

      //æœç´¢åŒºåŸŸ
      Row() {
        Image($r('app.media.ic_search'))
          .width(22)
          .fillColor('#817D83')
        TextInput({ placeholder: 'åªå› ä½ å¤ªç¾ğŸ”¥' })
          .placeholderColor('#817D83')
          .padding({ left: 5 })
          .fontColor('#999')
          .layoutWeight(1)
        Image($r('app.media.ic_code'))
          .width(20)
          .fillColor('#817D83')
      }
      .width('100%')
      .backgroundColor('#2D2B29')
      .border({ radius: 20 })
      .padding({ left: 8, right: 8 })

      Refresh({ refreshing: this.refreshing }) {
        Scroll(){
          Column() {
            //è½®æ’­å›¾
            Swiper() {
              ForEach(this.swiperList, (item: string) => {
                Image(item)
                  .width('100%')
                  .border({ radius: 10 })
              })
            }
            .height(170)
            .autoPlay(true)

            //æ¯æ—¥æ¨è
            this.titleBuilder("æ¯æ—¥æ¨è")
            List() {
              ForEach(this.dailyRecommend, (item: recommendDailyType, index: number) => {
                ListItem() {
                  Column() {
                    Text(item.type)
                      .width('100%')
                      .height(40)
                      .backgroundColor(item.top)
                      .padding({ left: 5 })
                      .fontSize(14)
                      .fontColor('#fff')
                    Image(item.img)
                      .width('100%')
                    Text(item.title)
                      .width('100%')
                      .backgroundColor(item.bottom)
                      .padding(5)
                      .fontSize(14)
                      .fontColor('#fff')
                      .maxLines(2)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                  .width('40%')
                  .border({ radius: 10 })
                  .margin({ right: 10 })
                  .clip(true)
                }
              })
            }
            .height(230)
            .scrollBar(BarState.Off)
            .listDirection(Axis.Horizontal)

            //æ¨èæ­Œå•
            this.titleBuilder('æ¨èæ­Œå•')
            List() {
              ForEach(this.chunk(this.recommendList, 3), (group: recommendListType[], rowIndex: number) => {
                ListItem() {
                  Row({ space: 10 }) {
                    ForEach(group, (item: recommendListType, index: number) => {
                      Column() {
                        Stack() {
                          Image(item.img)
                            .width('100%')
                            .height(100)
                            .border({ radius: 8 })

                          Text(item.count)
                            .fontColor('#fff')
                            .fontSize(12)
                            .fontWeight(700)
                            .margin({ left: 5, top: 5 })
                        }
                        .alignContent(Alignment.TopStart)

                        Text(item.title)
                          .fontColor('#fff')
                          .fontSize(14)
                          .width('100%')
                          .padding(5)
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                      }
                      .width('30%') // æ¯è¡Œä¸‰ä¸ª
                    }, (item: recommendListType) => item.title) // ä½¿ç”¨å”¯ä¸€ key
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.SpaceBetween)
                  .padding(10)
                }
              }, (rowIndex: number) => rowIndex.toString())
            }
            .scrollBar(BarState.Off)
          }
        }
        .scrollBar(BarState.Off)
      }
      .onRefreshing(() => {
        this.refreshing = true
        setTimeout(() => {
          this.refreshing = false
        }, 3000)
      })
    }
    .width('100%').height('100%')
    .padding({
      left: 10,
      right: 10,
      top: 5,
      bottom: 5
    })
  }

  chunk<T>(arr: T[], size: number): T[][] {
    const result: T[][] = []
    for (let i = 0; i < arr.length; i += size) {
      result.push(arr.slice(i, i + size))
    }
    return result
  }
}